name: Migrate Database to DigitalOcean

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Migration mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - schema-only
          - seed-only
          - migration
          - all-migrations
      migration_files:
        description: 'Migration file name (required when mode is "migration")'
        required: false
        type: string
      confirm:
        description: 'Type "yes" to confirm migration'
        required: true
        type: string

jobs:
  validate:
    name: Validate Migration Request
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [[ "${{ github.event.inputs.confirm }}" != "yes" ]]; then
            echo "❌ Migration not confirmed. Please type 'yes' in the confirm field."
            exit 1
          fi
          echo "✓ Migration confirmed"

      - name: Display migration plan
        run: |
          echo "Migration Plan:"
          echo "  Mode: ${{ github.event.inputs.mode }}"
          if [[ "${{ github.event.inputs.mode }}" == "migration" ]]; then
            if [[ -z "${{ github.event.inputs.migration_files }}" ]]; then
              echo "❌ Migration file name is required when mode is 'migration'"
              exit 1
            fi
            echo "  Migration File: ${{ github.event.inputs.migration_files }}"
          fi
          echo "  Target: DigitalOcean PostgreSQL"
          echo "  Triggered by: ${{ github.actor }}"
          echo "  Commit: ${{ github.sha }}"

  migrate:
    name: Run Database Migration
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get runner IP address
        id: ip
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Runner IP: $RUNNER_IP"
          echo "ip=$RUNNER_IP" >> $GITHUB_OUTPUT

      - name: Whitelist runner IP in DigitalOcean
        id: whitelist
        env:
          DO_TOKEN: ${{ secrets.DO_TOKEN }}
          DB_ID: ${{ secrets.DB_ID }}
          RUNNER_IP: ${{ steps.ip.outputs.ip }}
        run: |
          echo "Adding IP $RUNNER_IP to database trusted sources..."
          
          # Add the runner IP to the database firewall
          RESPONSE=$(curl -s -X PUT \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DO_TOKEN" \
            -d "{\"rules\": [{\"type\": \"ip_addr\", \"value\": \"$RUNNER_IP\"}]}" \
            "https://api.digitalocean.com/v2/databases/$DB_ID/firewall")
          
          if echo "$RESPONSE" | grep -q "error"; then
            echo "❌ Failed to whitelist IP"
            echo "$RESPONSE"
            exit 1
          fi
          
          echo "✓ IP whitelisted successfully"
          echo "Waiting 10 seconds for firewall rules to propagate..."
          sleep 10

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq

      - name: Install doctl
        run: |
          cd /tmp
          wget https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz
          tar xf doctl-1.104.0-linux-amd64.tar.gz
          sudo mv doctl /usr/local/bin
          doctl version

      - name: Prepare migration script
        run: |
          chmod +x scripts/migrate-to-do.sh
          chmod +x scripts/grant-permissions.sh

      - name: Run migration
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          SSL_MODE: require
        run: |
          cd scripts
          
          case "${{ github.event.inputs.mode }}" in
            schema-only)
              echo "Running schema-only migration..."
              ./migrate-to-do.sh --schema-only
              ;;
            seed-only)
              echo "Running seed-only migration..."
              ./migrate-to-do.sh --seed-only
              ;;
            full)
              echo "Running full migration (schema + seed)..."
              ./migrate-to-do.sh
              ;;
            migration)
              if [[ -z "${{ github.event.inputs.migration_files }}" ]]; then
                echo "❌ Migration file name is required when mode is 'migration'"
                exit 1
              fi
              echo "Running specific migration: ${{ github.event.inputs.migration_files }}"
              ./migrate-to-do.sh --migration "${{ github.event.inputs.migration_files }}"
              ;;
            all-migrations)
              echo "Running all migrations..."
              ./migrate-to-do.sh --all-migrations
              ;;
            *)
              echo "Unknown mode: ${{ github.event.inputs.mode }}"
              exit 1
              ;;
          esac

      - name: Grant database permissions
        if: github.event.inputs.mode != 'seed-only'
        env:
          DO_TOKEN: ${{ secrets.DO_TOKEN }}
          DB_ID: ${{ secrets.DB_ID }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_ADMIN_PASSWORD: ${{ secrets.DB_ADMIN_PASSWORD }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          APP_DB_USER: ${{ secrets.APP_DB_USER }}
        run: |
          echo ">> Granting database permissions to app user..."
          
          # Use admin password if set, otherwise fall back to regular DB password
          if [[ -n "$DB_ADMIN_PASSWORD" ]]; then
            export DB_PASSWORD="$DB_ADMIN_PASSWORD"
          elif [[ -z "$DB_PASSWORD" ]]; then
            echo "⚠️  DB_ADMIN_PASSWORD or DB_PASSWORD secret not set, skipping permission grant"
            echo "   You may need to grant permissions manually"
            exit 0
          fi
          
          cd scripts
          
          # Get cluster name from DB_ID using doctl (handle both array and object responses)
          doctl auth init -t "$DO_TOKEN" >/dev/null
          CLUSTER_JSON=$(doctl databases get "$DB_ID" --output json)
          
          # Handle both array and object formats
          if echo "$CLUSTER_JSON" | jq -e 'type == "array"' >/dev/null 2>&1; then
            CLUSTER_NAME=$(echo "$CLUSTER_JSON" | jq -r '.[0].name // empty')
          else
            CLUSTER_NAME=$(echo "$CLUSTER_JSON" | jq -r '.name // empty')
          fi
          
          if [[ -z "$CLUSTER_NAME" ]]; then
            echo "⚠️  Could not determine cluster name, skipping permission grant"
            echo "   You may need to grant permissions manually"
            exit 0
          fi
          
          # Set environment variables for the script
          export DB_CLUSTER_NAME="$CLUSTER_NAME"
          export DB_CLUSTER_ID="$DB_ID"
          export APP_DB_USER="${APP_DB_USER:-xq_app_user}"
          
          # Run the grant permissions script
          ./grant-permissions.sh || {
            echo "⚠️  Permission grant failed, but continuing..."
            echo "   You may need to grant permissions manually"
          }

      - name: Remove runner IP from whitelist
        if: always()
        env:
          DO_TOKEN: ${{ secrets.DO_TOKEN }}
          DB_ID: ${{ secrets.DB_ID }}
        run: |
          echo "Cleaning up: Removing runner IP from trusted sources..."
          
          # Reset to original firewall rules (or keep it - adjust as needed)
          # This removes the temporary IP we added
          curl -s -X PUT \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DO_TOKEN" \
            -d '{"rules": []}' \
            "https://api.digitalocean.com/v2/databases/$DB_ID/firewall" || true
          
          echo "✓ Cleanup completed"

      - name: Migration summary
        if: success()
        run: |
          echo "✓ Migration completed successfully!"
          echo ""
          echo "Summary:"
          echo "  Mode: ${{ github.event.inputs.mode }}"
          echo "  Database: ${{ secrets.DB_NAME }}"
          echo "  Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Migration failed!"
          echo "Please check the logs above for details."
          exit 1

